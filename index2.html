<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Игра 'Я никогда не...' - интерактивная карточная игра">
    <title>Игра "Я никогда не..."</title>
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
    
    <!-- Preconnect для быстрой загрузки внешних ресурсов -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    
    <!-- Критичный CSS инлайн -->
    <style>
        :root {
            --color-primary: #BA9868;
            --color-secondary: #EBCEA7;
            --color-bg-dark: #15273F;
            --color-bg-medium: #23385A;
            --color-bg-light: #1a2d4a;
            --color-text: #CCCCCC;
            --color-border: #404A5B;
            --color-outline: #2E3952;
            --border-radius: 8px;
            --transition-speed: 0.2s;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @font-face {
            font-family: 'Romul';
            src: url('./font/Romul.woff2') format('woff2'),
                 url('./font/Romul.woff') format('woff');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        body {
            background-image: url('./img/background.jpg');
            background-repeat: repeat;
            background-position: top left;
            background-attachment: fixed;
            font-family: "Open Sans", "Segoe UI", Tahoma, sans-serif;
            font-size: 14px;
            font-weight: 400;
            overflow-x: hidden;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .container {
            width: 100%;
            max-width: 1066px;
            min-width: 320px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
        }

        .outer-border {
            background: var(--color-bg-dark);
            padding: 14px;
            border: 40px solid transparent;
            border-image: url('https://drive.dhog.org/rave/images/border.svg') 40 40 40 40 / 40px 40px 40px 40px stretch;
        }

        .banner-wrapper {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .banner {
            width: 100%;
            max-width: 1010px;
            height: auto;
            aspect-ratio: 1010 / 315;
            position: relative;
            overflow: hidden;
        }

        .banner-bg {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }

        .banner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            z-index: 2;
        }

        .banner-frame {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 30px solid transparent;
            border-image: url('https://drive.dhog.org/rave/images/inner-border.svg') 30 30 30 30 / 30px 30px 30px 30px stretch;
            box-sizing: border-box;
            z-index: 3;
            pointer-events: none;
        }

        .banner-title {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 4;
            font-family: 'Romul', serif;
            font-size: clamp(20px, 4vw, 28px);
            color: var(--color-primary);
            text-shadow: 
                -2px -2px 0 var(--color-outline),
                2px -2px 0 var(--color-outline),
                -2px 2px 0 var(--color-outline),
                2px 2px 0 var(--color-outline);
            letter-spacing: 2px;
            font-weight: bold;
            white-space: nowrap;
        }

        .breadcrumb {
            background: var(--color-bg-dark);
            padding: 8px 20px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--color-text);
        }

        .breadcrumb a {
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            transition: opacity var(--transition-speed);
        }

        .breadcrumb a:hover {
            opacity: 0.8;
        }

        .breadcrumb i {
            font-size: 11px;
            width: 11px;
            height: 15px;
            color: var(--color-primary);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .breadcrumb-separator {
            color: var(--color-text);
        }

        .breadcrumb-text {
            color: var(--color-primary);
        }

        .content {
            background: var(--color-bg-dark);
            padding: 30px 40px 40px;
            min-height: 300px;
            color: var(--color-text);
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .game-title {
            font-family: 'Romul', serif;
            color: var(--color-primary);
            font-weight: normal;
            margin-bottom: 0;
            font-size: clamp(24px, 5vw, 150%);
            line-height: 1.16;
            letter-spacing: 3px;
            margin-top: 5px;
        }

        .raven-container {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: transform var(--transition-speed);
            margin-top: 10px;
        }

        .raven-container:hover {
            transform: scale(1.05);
        }

        .raven-icon {
            width: 40px;
            height: 40px;
            object-fit: contain;
        }

        .raven-tooltip {
            font-size: 12px;
            color: var(--color-text);
            max-width: 200px;
            line-height: 1.3;
        }

        .game-subtitle {
            font-family: 'Romul', serif;
            color: var(--color-primary);
            font-weight: normal;
            text-align: center;
            margin-bottom: 30px;
            font-size: clamp(20px, 4vw, 125%);
            line-height: 1.16;
            letter-spacing: 2px;
        }

        .rules-list {
            list-style: none;
            margin-bottom: 40px;
            padding-left: 0;
            counter-reset: rule-counter;
        }

        .rules-list li {
            color: var(--color-text);
            font-size: 14px;
            line-height: 1.8;
            margin-bottom: 10px;
            padding-left: 25px;
            position: relative;
            counter-increment: rule-counter;
        }

        .rules-list li::before {
            content: counter(rule-counter) ".";
            color: var(--color-primary);
            position: absolute;
            left: 0;
        }

        .game-area {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 60px;
            min-height: 400px;
            margin: 20px 0 40px;
        }

        .card-deck {
            position: relative;
            width: 240px;
            height: 336px;
            cursor: pointer;
            transition: transform var(--transition-speed) ease;
            will-change: transform;
        }

        .card-deck:hover {
            transform: scale(1.05);
        }

        .card-deck:active {
            transform: scale(0.98);
        }

        .card-deck img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .cards-display {
            position: relative;
            width: 240px;
            height: 336px;
        }

        .drawn-card {
            position: absolute;
            width: 240px;
            height: 336px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            animation: cardAppear 0.5s ease-out;
            transform-origin: left center;
        }

        .drawn-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: var(--border-radius);
        }

        @keyframes cardAppear {
            from {
                opacity: 0;
                transform: translateX(-100px) rotate(-10deg);
            }
            to {
                opacity: 1;
                transform: translateX(0) rotate(0deg);
            }
        }

        .report-section {
            margin: 40px 0;
            text-align: center;
        }

        .report-title {
            font-family: 'Romul', serif;
            color: var(--color-primary);
            font-weight: normal;
            margin-bottom: 20px;
            font-size: 125%;
            line-height: 1.16;
            letter-spacing: 2px;
            cursor: pointer;
            transition: color var(--transition-speed);
            user-select: none;
        }

        .report-title:hover {
            color: #d4b98c;
        }

        .code-area {
            background: var(--color-bg-light);
            border: 1px solid var(--color-primary);
            border-radius: 2px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: left;
            display: none;
        }

        .code-text {
            color: var(--color-text);
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-break: break-all;
            margin-bottom: 15px;
            min-height: 60px;
        }

        .highlight {
            background-color: #2c3e50;
            color: var(--color-primary);
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color var(--transition-speed);
        }

        .highlight:hover {
            background-color: #3a5068;
        }

        .editable-input {
            background-color: #2c3e50;
            color: #ffcc00;
            border: 1px solid var(--color-primary);
            border-radius: 3px;
            padding: 2px 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            width: 300px;
            max-width: 100%;
        }

        .report-buttons {
            display: none;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .report-button {
            background: var(--color-bg-medium);
            color: var(--color-secondary);
            border: 1px solid var(--color-border);
            padding: 8px 16px;
            border-radius: 2px;
            cursor: pointer;
            font-weight: normal;
            transition: background var(--transition-speed);
            text-decoration: none;
            display: inline-block;
        }

        .report-button:hover {
            background: #a88658;
        }

        .report-button:active {
            transform: translateY(1px);
        }

        /* Модальное окно для задания */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-speed), visibility var(--transition-speed);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--color-bg-dark);
            border: 2px solid var(--color-primary);
            border-radius: var(--border-radius);
            padding: 25px;
            max-width: 500px;
            width: 90%;
            position: relative;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: var(--color-primary);
            font-size: 20px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-title {
            font-family: 'Romul', serif;
            color: var(--color-primary);
            font-size: 20px;
            margin-bottom: 15px;
            text-align: center;
        }

        .modal-task {
            color: var(--color-text);
            line-height: 1.6;
            text-align: center;
        }

        /* Адаптивность */
        @media (max-width: 1100px) {
            body { padding: 15px; }
            .outer-border {
                padding: 12px;
                border-width: 35px;
            }
            .content { padding: 25px 35px 35px; }
            .breadcrumb { padding: 7px 18px; font-size: 11px; }
        }

        @media (max-width: 950px) {
            body { padding: 12px; }
            .outer-border {
                padding: 10px;
                border-width: 30px;
            }
            .banner-wrapper { margin-bottom: 15px; }
            .content { padding: 20px 30px 30px; }
            .breadcrumb { padding: 6px 16px; font-size: 11px; }
            .game-header {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            .raven-container {
                margin-top: 15px;
            }
        }

        @media (max-width: 800px) {
            .game-area {
                flex-direction: column;
                gap: 40px;
            }
            .card-deck,
            .cards-display,
            .drawn-card {
                width: 200px;
                height: 280px;
            }
            .report-buttons {
                flex-direction: column;
                align-items: center;
            }
        }

        @media (max-width: 500px) {
            .rules-list li { font-size: 14px; }
            .card-deck,
            .cards-display,
            .drawn-card {
                width: 180px;
                height: 252px;
            }
            .raven-tooltip {
                max-width: 150px;
                font-size: 11px;
            }
        }

        /* Accessibility improvements */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Loading state */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" media="print" onload="this.media='all'">
</head>
<body>
    <div class="container">
        <div class="outer-border">
            <div class="banner-wrapper">
                <div class="banner">
                    <img src="./img/head.jpg" 
                         alt="Баннер вечерней башни" 
                         class="banner-bg"
                         width="1010"
                         height="315"
                         loading="eager">
                    <img src="./img/windows.png" 
                         alt="" 
                         class="banner-overlay"
                         width="1010"
                         height="315"
                         loading="eager"
                         aria-hidden="true">
                    <div class="banner-frame" aria-hidden="true"></div>
                    <h1 class="banner-title">БАШНЯ КОГТЕВРАН</h1>
                </div>
            </div>

            <nav class="breadcrumb" aria-label="Навигация">
                <span class="breadcrumb-separator">В Башне:</span>
                <a href="https://rave.dhog.org/memberlist.php?mode=viewprofile&u=231">
                    <span class="breadcrumb-text">Тедди.</span>
                </a>
                <span class="breadcrumb-separator">Всего: 1</span>
                <a href="https://rave.dhog.org/viewonline.php?sid=5082a57fe6cd5c9d7b38977d9e0e58ca?sg=1">
                    <span class="breadcrumb-text">[подробнее...]</span>
                </a>
            </nav>
            
            <nav class="breadcrumb" aria-label="Хлебные крошки">
                <a href="https://rave.dhog.org/index.php?sid=975d79a61573d6c6e721eee1f39a6e20" aria-label="Главная">
                    <i class="fab fa-fort-awesome"></i>
                </a>
                <span class="breadcrumb-separator">></span>
                <a href="#" aria-current="page">
                    <span class="breadcrumb-text">Игра "Я никогда не..."</span>
                </a>
            </nav>

            <main class="content">
                <div class="game-header">
                    <h2 class="game-title">Игра "Я никогда не..."</h2>
                    <div class="raven-container" id="ravenContainer">
                        <img src="./img/raven1.png" 
                             alt="Сварливая ворона" 
                             class="raven-icon" 
                             id="ravenIcon">
                        <span class="raven-tooltip">Если у вас не загружается изображение карты или вы не видите текст текущего задания - спросите сварливую ворону</span>
                    </div>
                </div>
                
                <div class="game-area">
                    <div class="card-deck" 
                         onclick="gameController.drawCard()" 
                         role="button" 
                         tabindex="0"
                         aria-label="Вытянуть карту"
                         onkeypress="if(event.key==='Enter'||event.key===' ')gameController.drawCard()">
                        <img src="./img/card-back.png" 
                             alt="Колода карт"
                             width="240"
                             height="336"
                             loading="lazy">
                    </div>
                    
                    <div class="cards-display" 
                         id="cardsDisplay" 
                         role="region" 
                         aria-live="polite"
                         aria-label="Вытянутая карта"></div>
                </div>

                <section class="report-section">
                    <h3 class="report-title" 
                        onclick="gameController.toggleReportCode()"
                        role="button"
                        tabindex="0"
                        aria-expanded="false"
                        aria-controls="codeArea"
                        onkeypress="if(event.key==='Enter'||event.key===' ')gameController.toggleReportCode()">
                        ОТПРАВИТЬ ОТЧЕТ <i class="fas fa-feather-alt"></i>
                    </h3>
                    
                    <div class="code-area" id="codeArea" role="region" aria-label="Код для копирования">
                        <div class="code-text" id="reportCode"></div>
                    </div>
                    
                    <div class="report-buttons" id="reportButtons">
                        <button class="report-button" 
                                onclick="gameController.copyCode()"
                                aria-label="Копировать код отчета">
                            Копировать код
                        </button>
                        <a href="https://dhog.org/forum.php" 
                           class="report-button" 
                           id="reportLink" 
                           target="_blank"
                           rel="noopener noreferrer">
                            Отправить отчет
                        </a>
                    </div>
                </section>

                <h3 class="game-subtitle">ПРАВИЛА ИГРЫ</h3>
                
                <ol class="rules-list">
                    <li>Правило первое</li>
                    <li>Правило второе</li>
                    <li>Правило третье</li>
                    <li>Правило четвертое</li>
                    <li>Правило пятое</li>
                </ol>
            </main>
        </div>
    </div>

    <!-- Модальное окно для задания -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <button class="modal-close" id="modalClose">&times;</button>
            <h3 class="modal-title" id="modalTitle"></h3>
            <p class="modal-task" id="modalTask"></p>
        </div>
    </div>

    <script>
        // Оптимизированный игровой контроллер
        const gameController = (() => {
            // Приватные переменные
            const cards = [
                { 
                    url: './img/Винсент Бернкастель.jpg', 
                    name: 'Винсент Берканстель',
                    task: 'Я никогда не писал дифирамб когтевранцу, в котором аргументированно обяснял, почему он типичный когтевранец'
                },
                { 
                    url: './img/Блейк Эллингтон.jpg', 
                    name: 'Блейк Эллингтон',
                    task: 'Я никогда не пытался доказать преподавателю Эллингтон, что можно создать философский камень из подручных средств'
                },
                { 
                    url: './img/Гефест Ханнем.jpg', 
                    name: 'Гефест Ханнем',
                    task: 'Я никогда не делал мем на тему "Тяжело быть Вороном"'
                },
                { 
                    url: './img/Grace Diamond-de-Kur.jpg', 
                    name: 'Grace Diamond-de-kur',
                    task: 'Я никогда не сочинял песни о возможных тайнах и секретах когтевранцев'
                },
                { 
                    url: './img/Merida Croved.jpg', 
                    name: 'Мерида Кравд',
                    task: 'Я никогда не составлял ребус на тематику связанную с сапфирами'
                },
                { 
                    url: './img/Darsy Fist.jpg', 
                    name: 'Дарси Фист',
                    task: 'Я никогда не подбирал соседство фруктов исходя из звуковых свойств шелеста их листьев'
                },
                { 
                    url: './img/Mason Clark.jpg', 
                    name: 'Мейсон Кларк',
                    task: 'Я никогда не составлял чай со вкусом синих леденцов'
                },
                { 
                    url: './img/Leeroy Vander.jpg', 
                    name: 'Leeroy Vander',
                    task: 'Я никогда не составлял плей-лист про птиц'
                },
                { 
                    url: './img/Эрин Барнс.jpg', 
                    name: 'Эрин Барнс',
                    task: 'Я никогда не создавал новый дизайн герба Когтеврана'
                },
                { 
                    url: './img/Эрик Смит.jpg', 
                    name: 'Эрик Смит',
                    task: 'Я никогда не писал стихов, где рифмуются «орёл» и «умён»'
                },
                { 
                    url: './img/Эйриан Гамильтон.jpg', 
                    name: 'Эйриан Гамильтон',
                    task: 'Я никогда не создавал коллекцию модных наволочек для Тедди'
                },
                { 
                    url: './img/Шарлина Квик.jpg', 
                    name: 'Шарлина Квик',
                    task: 'Я никогда не рассказывал сказку, в которой присутствуют слова "Ворон", "Воздух", "Розовый" и "Синий"'
                },
                { 
                    url: './img/Милисента О`Ранйяр.jpg', 
                    name: 'Милисента О`Ранйяр',
                    task: 'Я никогда не пытался сыграть роль того самого мудрого Стража Ravenclaw, дающего загадки'
                },
                { 
                    url: './img/Роджер Дэвис.jpg', 
                    name: 'Роджер Девис',
                    task: 'Я никогда не придумывал кричалку, в которой есть слова "Леденцовый дождь", "Птичий строй" и "Орлиное семейство"'
                },
                { 
                    url: './img/Мизуки Хироми.jpg', 
                    name: 'Мизуки Хироми',
                    task: 'Я никогда не составля топ самых когтевранских тем для статей'
                },
                { 
                    url: './img/Шуга Ренн.jpg', 
                    name: 'Шуга Ренн',
                    task: 'Я никогда не писал отзыв на книгу, в названии или на обложке которой есть слово "Орёл", "Ворон" или "птицы"'
                },
                { 
                    url: './img/Криста.jpg', 
                    name: 'Криста',
                    task: 'Я никогда не изучал, и не составлял идеальный, с точки зрения хронотипа, свой график занятий'
                },
                { 
                    url: './img/Кланкер.jpg', 
                    name: 'Кланкер',
                    task: 'Я никогда не участвовал в дебатах с Тыквами Душнилой, Зельеваром и Читающей, о том, что идеальнее: острота ума или острота заточенного пера'
                },
                { 
                    url: './img/Эмберли Шрив.jpg', 
                    name: 'Эмберли Шрив',
                    task: 'Я никогда не пытался провести сеанс психоанализа с Серой Леди, чтобы выяснить причину ее вечной меланхолии'
                },
                { 
                    url: './img/Женевьева Пресли.jpg', 
                    name: 'Женевьева Пресли',
                    task: 'Я никогда не составлял инструкцию "как получить 17" у когтевранского преподавателя'
                },
                { 
                    url: './img/Джин Фрай.jpg', 
                    name: 'Джин Фрай',
                    task: 'Я никогда не изготавливал свечу, запах которой ассоциируется с Когтевраном'
                },
                { 
                    url: './img/Джиллиан Фрай-Барнс.jpg', 
                    name: 'Джиллиан Фрай-Барнс',
                    task: 'Я никогда не пытался вывести новый сорт растения с листьями цвета глубокого синего шёлка'
                },
                { 
                    url: './img/Джек Фишер.jpg', 
                    name: 'Джек Фишер',
                    task: 'Я никогда не составлял подборку фильмов, где главная роль - птичья'
                },
                { 
                    url: './img/Первые выпускники.jpg', 
                    name: 'Первые выпускники',
                    task: 'Я никогда не создавал когтевранский гороскоп'
                },
                { 
                    url: './img/Выпускницы - настоящие леди.jpg', 
                    name: 'Выпускницы-леди',
                    task: 'Я никогда не пытался выразить свое негодование от неразгаданной загадки в форме стиха'
                },
                { 
                    url: './img/Выпускники - старосты.jpg', 
                    name: 'Выпускники-старосты',
                    task: 'Я никогда не составлял кроссворд, где бы каждое слово начиналось на букву "к"'
                },
                { 
                    url: './img/Выпускники - созидатели.jpg', 
                    name: 'Выпускники-созидатели',
                    task: 'Я никогда не приносил в когтевранскую библиотеку подборку самых полезных книг для учебы'
                },
                { 
                    url: './img/Выпускники - сама загадочность.jpg', 
                    name: 'Выпускники - сама загадочность',
                    task: 'Я никогда не отыгрывал перед директором особу голубых кровей, которая требует уважать её власть'
                },
                { 
                    url: './img/Adelin Delhi-Shafer.jpg', 
                    name: 'Adelin Delhi-Shafer',
                    task: 'Я никогда не устраивал митинг под дверями профессора Дели-Шефер, с требованием писать ещё лекций'
                },
                { 
                    url: './img/Лиария Спраут.jpg', 
                    name: 'Лиария Спраут',
                    task: 'Я никогда не составлял мемы по Заклинаниям'
                },
                { 
                    url: './img/Соланж Деллингхейм.jpg', 
                    name: 'Соланж Деллингхейм',
                    task: 'Я никогда не танцевал "танец с бубном" для профессора Шаманизма'
                },
                { 
                    url: './img/Шелия МакБрайд.jpg', 
                    name: 'Шелия МакБрайд',
                    task: 'Я никогда не создавал новые руны'
                },
                { 
                    url: './img/Лучшая пара выпускников.jpg', 
                    name: 'Лучшая пара выпускников',
                    task: 'Я никогда не писал веселую статью на тему "Как понять: ты орел или ворон?"'
                }
            ];

            let currentCard = null;
            let userReportLink = "Accio, ссылка на отчет!";
            let isCodeAreaVisible = false;
            let isModalOpen = false;

            // DOM элементы (кешируем для производительности)
            const elements = {
                display: null,
                codeArea: null,
                reportCode: null,
                reportButtons: null,
                reportLink: null,
                reportTitle: null,
                ravenContainer: null,
                ravenIcon: null,
                modalOverlay: null,
                modalClose: null,
                modalTitle: null,
                modalTask: null
            };

            // Инициализация
            const init = () => {
                elements.display = document.getElementById('cardsDisplay');
                elements.codeArea = document.getElementById('codeArea');
                elements.reportCode = document.getElementById('reportCode');
                elements.reportButtons = document.getElementById('reportButtons');
                elements.reportLink = document.getElementById('reportLink');
                elements.reportTitle = document.querySelector('.report-title');
                elements.ravenContainer = document.getElementById('ravenContainer');
                elements.ravenIcon = document.getElementById('ravenIcon');
                elements.modalOverlay = document.getElementById('modalOverlay');
                elements.modalClose = document.getElementById('modalClose');
                elements.modalTitle = document.getElementById('modalTitle');
                elements.modalTask = document.getElementById('modalTask');

                // Добавляем обработчики событий для ворона
                elements.ravenContainer.addEventListener('click', toggleModal);
                elements.modalClose.addEventListener('click', closeModal);
                elements.modalOverlay.addEventListener('click', (e) => {
                    if (e.target === elements.modalOverlay) {
                        closeModal();
                    }
                });

                // Закрытие модального окна по ESC
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && isModalOpen) {
                        closeModal();
                    }
                });
            };

            // Вытянуть карту
            const drawCard = () => {
                if (!elements.display) return;

                // Очищаем предыдущую карту
                elements.display.innerHTML = '';
                
                // Выбираем случайную карту
                const randomCard = cards[Math.floor(Math.random() * cards.length)];
                currentCard = randomCard;
                
                // Создаем элемент карты
                const cardElement = document.createElement('div');
                cardElement.className = 'drawn-card';
                
                const img = document.createElement('img');
                img.src = randomCard.url;
                img.alt = `Карта: ${randomCard.name}`;
                img.width = 240;
                img.height = 336;
                img.loading = 'lazy';
                
                cardElement.appendChild(img);
                elements.display.appendChild(cardElement);
                
                // Обновляем код и ссылку
                updateReportCode();
                updateReportLink();

                // Анонсируем для screen readers
                elements.display.setAttribute('aria-label', `Вытянута карта: ${randomCard.name}`);

                // Закрываем модальное окно, если оно открыто
                if (isModalOpen) {
                    closeModal();
                }
            };

            // Переключить модальное окно
            const toggleModal = () => {
                if (!currentCard) {
                    alert('Сначала вытяните карту, чтобы увидеть задание');
                    return;
                }

                if (isModalOpen) {
                    closeModal();
                } else {
                    openModal();
                }
            };

            // Открыть модальное окно
            const openModal = () => {
                if (!currentCard) return;

                elements.modalTitle.textContent = currentCard.name;
                elements.modalTask.textContent = currentCard.task;
                elements.modalOverlay.classList.add('active');
                elements.ravenIcon.src = './img/raven2.png';
                isModalOpen = true;
                
                // Блокируем прокрутку фона
                document.body.style.overflow = 'hidden';
            };

            // Закрыть модальное окно
            const closeModal = () => {
                elements.modalOverlay.classList.remove('active');
                elements.ravenIcon.src = './img/raven1.png';
                isModalOpen = false;
                
                // Восстанавливаем прокрутку фона
                document.body.style.overflow = '';
            };

            // Переключить видимость кода
            const toggleReportCode = () => {
                isCodeAreaVisible = !isCodeAreaVisible;
                
                elements.codeArea.style.display = isCodeAreaVisible ? 'block' : 'none';
                elements.reportButtons.style.display = isCodeAreaVisible ? 'flex' : 'none';
                elements.reportTitle.setAttribute('aria-expanded', isCodeAreaVisible);
                
                if (isCodeAreaVisible) {
                    updateReportCode();
                    updateReportLink();
                }
            };

            // Обновить код отчета
            const updateReportCode = () => {
                if (!currentCard) {
                    elements.reportCode.innerHTML = 'Сначала вытяните карту';
                    return;
                }
                
                const code = `[width=200][img]${currentCard.url}[/img][/width]\n\n[url=<span class="highlight" onclick="gameController.editLink()" role="button" tabindex="0" id="editableLink">${userReportLink}</span>]Отчет по заданию: ${currentCard.name}[/url]`;
                elements.reportCode.innerHTML = code;
            };

            // Редактировать ссылку
            const editLink = () => {
                const editableLink = document.getElementById('editableLink');
                if (!editableLink) return;
                
                const currentText = editableLink.textContent;
                
                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentText;
                input.className = 'editable-input';
                input.id = 'linkInput';
                input.setAttribute('aria-label', 'Редактировать ссылку на отчет');
                
                editableLink.parentNode.replaceChild(input, editableLink);
                
                input.focus();
                input.select();
                
                const saveLink = () => {
                    userReportLink = input.value;
                    updateReportCode();
                };
                
                input.addEventListener('blur', saveLink);
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        input.blur();
                    }
                });
            };

            // Обновить ссылку отчета
            const updateReportLink = () => {
                if (!currentCard) return;
                
                // Замените URL на нужный вам форум
                elements.reportLink.href = `https://ваш-форум.ru/new-report?card=${encodeURIComponent(currentCard.name)}`;
            };

            // Копировать код (современный API)
            const copyCode = async () => {
                if (!currentCard) {
                    alert('Сначала вытяните карту');
                    return;
                }
                
                const plainCode = `[width=200][img]${currentCard.url}[/img][/width]\n\n[url=${userReportLink}]Отчет по заданию: ${currentCard.name}[/url]`;
                
                try {
                    // Используем современный Clipboard API
                    if (navigator.clipboard && window.isSecureContext) {
                        await navigator.clipboard.writeText(plainCode);
                    } else {
                        // Fallback для старых браузеров
                        const textArea = document.createElement('textarea');
                        textArea.value = plainCode;
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-999999px';
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                    }
                    
                    // Визуальное подтверждение
                    const button = event.target;
                    const originalText = button.textContent;
                    button.textContent = 'Скопировано!';
                    button.classList.add('loading');
                    
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.classList.remove('loading');
                    }, 2000);
                    
                } catch (err) {
                    console.error('Ошибка копирования:', err);
                    alert('Не удалось скопировать код');
                }
            };

            // Инициализация при загрузке DOM
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }

            // Публичный API
            return {
                drawCard,
                toggleReportCode,
                editLink,
                copyCode
            };
        })();

        // Service Worker для кеширования (опционально)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Раскомментируйте, если создадите service worker
                // navigator.serviceWorker.register('./sw.js');
            });
        }
    </script>
</body>
</html>
